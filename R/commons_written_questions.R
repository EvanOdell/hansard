
#' commons_written_questions
#'
#' Imports data on House of Commons written questions. If
#' @param mp_id Requests a member ID and returns a data frame with all written questions asked by that member.
#' @param answering_department Accepts a string with a department name or partial name, and returns all written questions by that department. The query acts as a search, so entering <health> will return all questions answered by the Department of Health.
#' @param start_date The earliest date to include in the data frame, if calling all divisions, using the date the question was tabled. Defaults to "1900-01-01".
#' @param end_date The latest date to include in the data frame, if calling all divisions, using the date the question was tabled. Defaults to current system date.
#' @keywords House of Commons Written Questions
#' @export
#' @examples \dontrun{
#' x <- commons_written_questions(mp_id=410, "cabinet office")
#' }

commons_written_questions <- function(mp_id = NULL, answering_department=NULL,
                                      start_date="1900-01-01", end_date=Sys.Date()) {

    dates <-paste0("&_properties=dateTabled&max-dateTabled=", end_date, "&min-dateTabled=", start_date)

    if (is.null(mp_id)==FALSE){
      mp_id <- paste0("&tablingMember=http://data.parliament.uk/members/", mp_id)

      mp_id <- utils::URLencode(mp_id)
    }

    if (is.null(answering_department)==FALSE){

      query <- "/answeringdepartment"

      answering_department <- paste0("q=",answering_department)

      answering_department <- utils::URLencode(answering_department)

    } else {

      query <- NULL

    }

        baseurl <- "http://lda.data.parliament.uk/commonswrittenquestions"

        message("Connecting to API")

        writ <- jsonlite::fromJSON(paste0(baseurl, query, ".json?", answering_department, mp_id, dates, "&_pageSize=500"), flatten=TRUE)

        writJpage <- round(writ$result$totalResults/writ$result$itemsPerPage, digits = 0)

        pages <- list()

        for (i in 0:writJpage) {
            mydata <- jsonlite::fromJSON(paste0(baseurl, query, ".json?",answering_department, mp_id, dates, "&_pageSize=500&_page=", i), flatten = TRUE)
            message("Retrieving page ", i + 1, " of ", writJpage + 1)
            pages[[i + 1]] <- mydata$result$items
        }

    df <- jsonlite::rbind.pages(pages[sapply(pages, length) > 0])  #The data frame that is returned

    if (nrow(df) == 0) {
        message("The request did not return any data. Please check your search parameters.")
    } else {
        df
    }
}
